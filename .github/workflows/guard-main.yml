name: Guard main from direct pushes
on:
  push:
    branches: [ main ]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Detect PR merge vs direct push
        id: detect
        run: |
          msg="${{ github.event.head_commit.message }}"
          if echo "$msg" | grep -qi "Merge pull request"; then
            echo "merge_pr=true" >> $GITHUB_OUTPUT
          else
            echo "merge_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Fail if direct push to main
        if: steps.detect.outputs.merge_pr == 'false'
        run: |
          echo "::error ::Direct push to main detected. Please revert and use a PR (dev → main)."
          exit 1

      - name: Open warning issue
        if: steps.detect.outputs.merge_pr == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Direct push to main detected',
              body: `Commit ${context.sha} was pushed directly to main. Please revert and merge via PR (dev → main).`
            });
