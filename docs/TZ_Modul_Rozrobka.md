# ТЗ: Модуль "Розробка" (FoodTech Automation / Lovable)

## 0) Призначення

Модуль **"Розробка"** — внутрішній модуль для супроводу циклу розробки зразків по **R&D заявках**, які вже переведені в статус **"В роботі"** у модулі **"Заявки R&D"** (через кнопку "Взяти в роботу", без змін у тому модулі).

Цикл у межах модуля:  

**Request (В роботі) → Recipe(s) → Sample(s) → Lab results → Pilot results → Handoff (переведення заявки в "Тестування")**

---

## 1) Доступи (на етапі MVP)

1. Модуль "Розробка" **видимий в меню** та доступний за URL **лише** ролям:

   - **Адміністратор**

   - **СОО**

2. Для інших ролей:

   - модуль не показувати в меню;

   - при прямому переході за URL — **403 / No access**.

3. На етапі розробки дозволяється наповнення тестових даних "під реального розробника" (потім видалити). Це не змінює RBAC у проді.

---

## 2) Джерело заявок та фільтр

1. Джерело: існуючі **R&D заявки** з модуля "Заявки R&D".

2. Об'єктом для модуля "Розробка" є заявки зі статусом **"В роботі"**.

3. Механізм "Взяти в роботу" та переведення в "В роботі" **вже реалізований** у модулі "Заявки R&D" і **не змінюється**.

---

## 3) Кодування (обов'язково)

### 3.1. Коди

- Код заявки: уже існує (напр. `RD-0004`, `RD-0015`).

- Код рецепту:  

  **`{RequestCode}/{RecipeSeq:02}`**  

  приклад: `RD-0004/01`

- Код зразка:  

  **`{RequestCode}/{RecipeSeq:02}/{SampleSeq:02}`**  

  приклад: `RD-0004/01/01`

### 3.2. Правила нумерації

1. `RecipeSeq` — двозначний (01…99), унікальний **у межах заявки**.

2. `SampleSeq` — двозначний (01…99), унікальний **у межах рецепту**.

3. Присвоєння:

   - новий рецепт: `max(RecipeSeq)+1` в межах заявки;

   - новий зразок: `max(SampleSeq)+1` в межах поточного рецепту.

4. Видалення не використовується: **лише архівація**.

5. Номери **не перевикористовуються**, "дірки" допускаються.

6. "Копія рецепту" створюється як новий рецепт з **наступним кодом** (новий `RecipeSeq`).

---

## 4) Робоча назва та відображення на тестуванні

1. Перед відправкою на тестування **обов'язково** присвоюється **робоча назва** (текстове поле) для обраного зразка.

2. Робоча назва:

   - вводиться **лише на фінальному етапі** перед відправкою на тестування;

   - **не обов'язково унікальна**.

3. Формат, який має відображатися на тестуванні:

   - **`"{WorkingName} ({SampleCode})"`**

   - приклад: `Запах копчення - 26 (RD-0004/01/01)`

---

## 5) Стадійність та "заморозка" даних (критично важливо)

### 5.1. Загальний принцип

У межах одного рецепту створюються зразки. Заявка може мати багато рецептів на різних стадіях.

### 5.2. Заморозка рецепту

- Рецепт дозволено редагувати **поки не виготовлено зразок**.

- Практичне правило для системи:

  - Рецепт **редагований**, якщо всі пов'язані зразки в статусі `Draft`;

  - Рецепт **стає locked**, коли хоча б один зразок переходить у статус **`Manufactured/Prepared`** (див. розділ 6).

- Після lock рецепту дозволено лише:

  - перегляд складу;

  - створення **нових зразків** на базі цього рецепту;

  - архівація рецепту.

### 5.3. Заморозка зразка

- Після "аналізу" (лабораторні дані) зразок не можна змінювати.

- Практичне правило:

  - склад/партія/lot-номери зразка можна редагувати **до відправки в лабораторію**;

  - після статусу `LabDone` (або після факту внесення lab-результатів і "Завершити лабораторію") — зразок **locked** по складу.

- Пілот дозволено тільки після завершення лабораторії.

---

## 6) Етапи/статуси (MVP включає Lab + Pilot)

### 6.1. Статуси зразка

(назви можна показувати українськими бейджами)

1. `Draft` — створений, дані ще можна редагувати

2. `Prepared` — зразок "виготовлений" (внесена партія в грамах + внесені lot-номери по інгредієнтах), рецепт блокується

3. `Lab` — заповнення лабораторних параметрів

4. `LabDone` — лабораторія завершена (зразок блокується по складу)

5. `Pilot` — заповнення дегустаційного листа

6. `PilotDone` — пілот завершено

7. `ReadyForHandoff` — готовий до відправки на тестування (введено робочу назву)

8. `HandedOff` — відправлено на тестування (заявка переведена в "Тестування")

### 6.2. Правила переходів

- `Draft → Prepared` дозволено лише якщо:

  - задано вагу партії зразка (грамів) > 0;

  - для кожного інгредієнта внесено `lot_number` (текст, без валідації).

- `Prepared → Lab` — дозволено завжди.

- `Lab → LabDone` — лише після заповнення лабораторних полів (мінімально: хоча б 1 значення або явний чек "аналіз виконано" — фінальна реалізація на рівні UI).

- `LabDone → Pilot` — дозволено.

- `Pilot → PilotDone` — після заповнення дегустаційних полів.

- `PilotDone → ReadyForHandoff` — при введенні робочої назви.

- `ReadyForHandoff → HandedOff` — викликає зміну статусу заявки R&D на "Тестування".

---

## 7) Дані: Recipe

### 7.1. Recipe поля

- `request_id` (посилання на заявку)

- `recipe_seq` (int)

- `recipe_code` (string, напр. `RD-0004/01`)

- `name` (опціонально, якщо потрібна внутрішня назва рецепту)

- `status` (Draft/Locked/Archived)

### 7.2. Інгредієнти рецепту

- Вводяться **довільним текстом** (поки без довідника 1С)

- Для кожного інгредієнта:

  - `ingredient_name` (text)

  - `grams` (number)

  - `percent` (auto) = grams / total_grams * 100

---

## 8) Дані: Sample

### 8.1. Sample поля

- `request_id`

- `recipe_id`

- `sample_seq` (int)

- `sample_code` (string, `RD-0004/01/01`)

- `batch_weight_g` (number, обов'язково)

- `working_name` (text, **обов'язково лише на етапі ReadyForHandoff**)

- `display_name` (computed) = `"{working_name} ({sample_code})"` (для тестування)

- `status` (як у розділі 6)

### 8.2. Розрахунок інгредієнтів зразка

При створенні/редагуванні зразка:

- `scale_factor = batch_weight_g / total_recipe_grams`

- `required_grams = recipe_ingredient_grams * scale_factor`

Для кожного інгредієнта зразка:

- `ingredient_name`

- `required_grams` (auto)

- `lot_number` (text, ручний ввід, без валідації)

---

## 9) Лабораторія (все заповнює розробник)

### 9.1. Перелік показників (зашити в UI, MVP)

На першому етапі довідник аналізів **не адмініструється**, перелік "зашитий" у UI.

Поля лабораторії (з файлу "Параметри контролю.xlsx"):

- Насипна щільність, г/дм³ — число

- Зовнішній вигляд — select або text (конфіг у UI)

- Колір — текст

- Запах — текст

- Смак — текст

- Масова частка хлоридів, % — число

- Вміст фосфатів, % — число

- Вологість, % — число

- pH — число

- Гідротація — текст

- Сила гелю, г/см3 — число

- В'язкість, cps — число

- Колірність — число

- Додаткова інформація — текст/числа

### 9.2. Логіка

- Лаб-дані редагуються на етапі `Lab`.

- Після `LabDone` — лабораторні дані **заморожуються**.

---

## 10) Пілот / дегустація (все заповнює розробник, дегустаторів НЕ робимо)

### 10.1. Модель даних

Пілот — **один** набір оцінок на зразок (не множимо дегустаторів/оцінки).

Шапка:

- № дегустаційного листа (text/number)

- Дата (date)

- Напрямок (select): **смако-ароматична суміш / функціональна суміш / барвник**

- Мета дегустації (text)

Оцінки (числа 1–10) + коментар:

- Зовнішній вигляд

- Колір

- Аромат

- Смак

- Консистенція

- Соковитість

- Вологість на зламі

- Синерезис (утворення бульйону)

- Утворення завитку

- Утворення малюнку на зламі

- Наявність волокон

- Щільність структури

- Наявність повітряних включень

- Загальна оцінка продукту

- Коментар (text)

### 10.2. Заморозка

- Пілот-дані редагуються в `Pilot`.

- Після `PilotDone` — пілот-дані **заморожуються**.

---

## 11) Handoff: відправка на тестування

### 11.1. Головне правило

Відправка на тестування відбувається **лише** з модуля "Розробка".

У модулі "Заявки R&D" існуючу кнопку "перевести в тестування" потрібно:

- або прибрати,

- або зробити недоступною (disabled) і додати підказку "Переведення в тестування виконується з модуля Розробка".

### 11.2. Що відбувається при handoff

1. Користувач обирає зразок, вводить **робочу назву**.

2. Натискає "Відправити на тестування".

3. Система:

   - переводить зразок у `HandedOff`;

   - **автоматично змінює статус заявки** в модулі "Заявки R&D" на **"Тестування"**;

   - **не переносить жодних інших даних** в "Заявки R&D" (усі деталі залишаються в модулі "Розробка").

---

## 12) UI/Екрани (мінімальний набір)

1. **Розробка → Заявки в роботі**  

   Список заявок зі статусом "В роботі". Колонки можна повторити як у "Заявки R&D" (Код, Замовник, Автор, Вид продукту, Напрямок, Пріоритет, Відповідальний, SLA тощо).

2. **Картка заявки (в Розробці)**  

   Вкладки:

   - Рецепти

   - Зразки (всі по заявці)

   - (опц.) Історія змін

3. **Картка рецепту**

   - склад (інгредієнт/грами/%)

   - кнопка "Створити зразок"

   - кнопка "Копія рецепту"

4. **Картка зразка**

   - партія (г)

   - таблиця інгредієнтів з `required_grams` і `lot_number`

   - блок "Лабораторія"

   - блок "Пілот/Дегустація"

   - блок "Handoff" (робоча назва + кнопка відправки)

---

## 13) Архівація

- Рецепти та зразки **не видаляються**, лише переводяться в `Archived`.

- Архівні елементи не впливають на нумерацію (номери не перевикористовуються).

---

## 14) Мінімальна схема таблиць (рекомендація)

Зберігаємо `recipe_seq` і `sample_seq` як int для коректного інкременту і будуємо `recipe_code/sample_code` як computed або persisted string.

- `dev_recipes`: request_id, recipe_seq, recipe_code, status, …

- `dev_recipe_ingredients`: recipe_id, ingredient_name, grams

- `dev_samples`: request_id, recipe_id, sample_seq, sample_code, batch_weight_g, working_name, status

- `dev_sample_lots`: sample_id, ingredient_name, required_grams, lot_number

- `dev_sample_lab`: sample_id, results_json, status

- `dev_sample_pilot`: sample_id, header_fields_json + scores_json, status

---

## 15) Acceptance Criteria (коротко)

1. Для заявки "В роботі" можна створити 2+ рецепти, кожен з кодом `RD-xxxx/NN`.

2. Для кожного рецепту можна створити 2+ зразки з кодом `RD-xxxx/NN/MM`, з авто-розрахунком required grams.

3. Після переводу зразка в `Prepared` — рецепт блокується від редагування складу.

4. Після `LabDone` — зразок блокується від змін складу/lot-номерів.

5. Пілот можливий лише після `LabDone`; після `PilotDone` дані пілоту блокуються.

6. Handoff можливий лише після введення робочої назви; при handoff статус заявки R&D змінюється на "Тестування", без копіювання даних.
