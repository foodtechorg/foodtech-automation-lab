# Технічне завдання: Впровадження бізнес-процесу «Закупівля ТМЦ»

## Мета та загальний опис

Метою є реалізація нового бізнес-процесу «Закупівля ТМЦ» (товарно-матеріальних цінностей) у веб-додатку Lovable для компанії Foodtech. Процес повинен бути інтегрований без порушення існуючого коду та логіки чинних процесів. Нова функціональність має бути розроблена з урахуванням майбутнього розширення (додавання нових етапів, інтеграцій тощо) без значних переробок.

**Основні завдання:**
- Додати новий бізнес-процес «Закупівля ТМЦ» паралельно з існуючими, забезпечивши вибір процесу через основне меню.
- Визначити ролі користувачів і їхні права в межах нового процесу.
- Описати структуру даних Заявки та Рахунку, їх поля і статуси.
- Розробити схеми статусів (етапів) Заявки та Рахунку, визначити логіку переходів і дії для кожної ролі.
- Визначити вимоги до UI (інтерфейсу користувача) та за необхідності до Backend/API для нового процесу.
- Забезпечити можливість розширення функціоналу в майбутньому (approval matrix, аналітика, нотифікації тощо) шляхом гнучкої архітектури та відповідної структури даних.

## Ролі користувачів та права доступу

У бізнес-процесі «Закупівля ТМЦ» беруть участь кілька ролей. Кожна роль має чітко визначені права доступу та дії в системі:

- **Заявник (будь-який користувач системи)** – може створювати нові Заявки на закупівлю ТМЦ. Заявник автоматично вважається замовником у створеній Заявці. Після створення Заявки заявник може переглядати її статуси та коментарі, але не редагувати після відправки на погодження (окрім випадку, коли Заявка відхилена і дозволене редагування для повторного подання).

- **Менеджер постачання/ЗЕД** – відповідає за опрацювання затверджених Заявок і взаємодію з постачальниками. Має права перегляду всіх заявок (навіть у чернетці та на погодженні), але в основному втручається після їх погодження керівництвом. Основні дії: створення Рахунку на основі Заявки, внесення інформації про постачальника та умови оплати, оновлення статусів позицій (наприклад, відмітка про доставку ТМЦ). Менеджер не може затверджувати Заявки або Рахунки – тільки готує та обробляє їх.

- **COO (Chief Operating Officer)** – відповідальний за погодження заявок і один із погоджувачів рахунків. Має право переглядати всі Заявки та Рахунки, що потребують погодження, а також історію дій. COO може затверджувати або відхиляти Заявки та Рахунки на етапі «На погодженні». Для заявок погодження COO є остаточним. Для рахунків погодження COO відбувається паралельно з погодженням CEO (без етапності).

- **CEO (Chief Executive Officer)** – погоджувач рахунків. Має доступ до всіх рахунків, що потребують його погодження, і журналу дій. CEO затверджує або відхиляє Рахунки на етапі «На погодженні». Погодження рахунків COO та CEO відбувається паралельно (без етапності): для переходу рахунку в наступний статус потрібні дві позитивні відповіді. Якщо хоча б один із них відхиляє рахунок, статус рахунку змінюється на «Відхилено».

- **Бухгалтер-казначей** – відповідає за оплату рахунків. Має доступ до Рахунків зі статусом «Оплата» (тобто затверджених до оплати) і може змінювати їх статус на «Оплачено» після фактичного здійснення оплати (вручну, оскільки інтеграції з банком поки що нема). Казначей може переглядати всі рахунки і заявки, але редагувати може тільки поля, пов'язані з позначенням оплати (наприклад, додати номер платіжного документу, дату оплати тощо).

- **Бухгалтер** – роль тільки для перегляду. Бухгалтер має доступ тільки на читання до всіх Заявок і Рахунків та їх статусів. Не може створювати або редагувати документи. Ця роль використовується для відстеження статусів, контролю закриття документів, оприбуткування ТМЦ у бухгалтерській системі тощо, але без можливості змін в системі Lovable.

**Примітка:** Ролі та їхні права реалізуються таким чином, щоб не вплинути на існуючі процеси. Нові права доступу додаються окремо, з врахуванням принципу least privilege (мінімально необхідних привілеїв). Існуючі ролі/користувачі не втратять свої права в інших бізнес-процесах, а новий процес ізольовано керує доступом у своїх рамках.

## Меню вибору бізнес-процесу

В додатку необхідно реалізувати кореневе меню (навігаційну панель) для вибору бізнес-процесів. Користувачі повинні мати можливість перемикатися між існуючими процесами і новим процесом «Закупівля ТМЦ» без перезапуску або виходу з системи.

**Вимоги до меню:**
- Додати новий пункт меню (або вкладку) – «Закупівля ТМЦ», що відображається поряд із наявними бізнес-процесами.
- Перехід до нового пункту меню відкриває інтерфейс саме для процесу закупівель, не змінюючи при цьому поведінку інших розділів. Логіка існуючих процесів (наприклад, інші типи заявок чи модулі системи) залишається незмінною.
- Забезпечити інтуїтивне відображення активного процесу. Наприклад, в заголовку або навігації має бути зрозуміло, що користувач зараз працює із модулем «Закупівля ТМЦ».
- Технічно реалізація меню повинна бути побудована таким чином, щоб додавання нового бізнес-процесу було модульним. Рекомендується використати механізм маршрутизації (routing) для завантаження окремих модулів/сторінок під кожен процес. Це дозволить у майбутньому додати інші бізнес-процеси, не переписуючи існуючий код, а лише додаючи нові маршрути та компоненти.

**UX/UI:** Перемикання між процесами повинно бути плавним. Наприклад, якщо користувач обирає «Закупівля ТМЦ», з'являється відповідний список заявок цього процесу. В іншому випадку – повертається до інтерфейсу іншого процесу. Це меню фактично діє як фільтр контексту для всієї системи.

## Структура даних: Заявка «Закупівля ТМЦ»

Заявка – це основний документ, який ініціює процес закупівлі. Кожна заявка містить заголовкову частину (реквізити заявки) та табличну частину (позиції – перелік товарів або послуг для закупівлі).

### Поля заявки

Основні поля, що повинні бути присутні в заявці:

| Поле | Тип даних | Опис |
|------|-----------|------|
| Номер заявки | Автонаступний номер / String | Унікальний ідентифікатор заявки (генерується автоматично за заданим шаблоном, нумерація розділена від інших процесів, щоб уникнути конфліктів). |
| Замовник | Довідник користувачів / String (readonly) | Користувач, який створив заявку. Заповнюється автоматично на основі поточного користувача. |
| Дата створення | DateTime (readonly) | Дата і час створення заявки. Автоматично проставляється системою при створенні. |
| Тип закупівлі | Перелік (dropdown) | Тип предмету закупівлі: ТМЦ (товари, матеріальні цінності) або Послуга. Визначається замовником при створенні заявки. |
| Бажана дата поставки | Date | Дата, до якої бажано отримати товар/послугу. Вказується замовником, не обов'язково обов'язкове поле, але допомагає планувати терміни. |
| Статус заявки | Перелік (enum) (readonly для більшості ролей) | Поточний статус заявки (див. нижче можливі статуси). Змінюється системою автоматично при переходах процесу або відповідальними особами при погодженні/відхиленні. |
| Список позицій | Масив об'єктів (таблиця) | Таблична частина, що містить одну або кілька позицій закупівлі. Кожна позиція описується набором полів (див. нижче). |

### Позиції заявки (таблична частина)

Кожна заявка може містити декілька позицій. Для кожної позиції закупівлі передбачені такі поля:

- **Найменування позиції** – назва товару або послуги, що планується закупити (рядок).
- **Одиниця виміру** – одиниця вимірювання для кількості (наприклад, шт., кг, л тощо). Може бути обрана з довідника одиниць або введена вручну.
- **Кількість** – числове поле, що вказує, скільки одиниць цього товару/послуги потрібно.
- **Статус позиції** – статус конкретної позиції, який відображає етап виконання для цієї позиції. На відміну від загального статусу заявки, статуси позицій можуть відрізнятися, особливо у випадку часткових поставок. (Перелік статусів позицій наведено далі).

**Примітка:** Поля «Замовник» та «Дата створення» повинні бути автоматично заповнені системою і недоступні для редагування користувачем. Це забезпечує трасування, хто і коли створив заявку. Поле «Статус заявки» також недоступне для ручного редагування – воно змінюється тільки відповідно до бізнес-логіки процесу (погодження, опрацювання тощо).

### Статуси заявки

Бізнес-процес заявки проходить через декілька статусів. Кожен статус відображає поточний етап опрацювання заявки. Нижче описано можливі статуси заявки та умови переходу між ними:

- **Чернетка** – початковий статус щойно створеної заявки. Заявка в цьому статусі ще не відправлена на погодження і може редагуватися замовником. Будь-який користувач при створенні заявки отримує чернетку, яку можна зберегти і пізніше відправити. Перехід зі статусу «Чернетка» відбувається, коли замовник ініціює команду «Відправити на погодження».

- **На погодженні** – заявка відправлена на затвердження COO. У цьому статусі вона доступна для перегляду COO (з правом дії) та, за потреби, інших ролей тільки для читання. COO переглядає заявку і може погодити або відхилити її. При погодженні COO заявка переходить у статус «В роботі». При відхиленні – статус змінюється на «Відхилена». Заявка залишається «На погодженні», доки рішення не прийнято. Підказка в інтерфейсі: поруч зі статусом відображається, від кого очікується погодження і скільки часу вона перебуває в цьому статусі (з фіксацією часу відправки на погодження). Це може бути повідомлення типу: «Очікує погодження: COO (2 дні)».

- **В роботі** – заявка погоджена керівництвом (COO) і передана на виконання. Перехід у цей статус відбувається автоматично після того, як COO погодив заявку. В статусі «В роботі» відповідальність переходить до менеджера постачання. Менеджер опрацьовує заявку: шукає постачальників, уточнює деталі. З цього статусу менеджер може створити на основі заявки Рахунок (платіжне доручення/рахунок від постачальника). Заявка залишається у статусі «В роботі», поки не буде повністю виконана (поставка здійснена). За потреби, після створення рахунку, заявка може отримати більш специфічний статус «Очікує поставки» або аналогічний (в даному техзавданні такий проміжний статус не виділено, використовується загальний «В роботі»).

- **Відхилена** – заявка не була погоджена керівництвом і відхилена на етапі погодження. Перехід у цей статус можливий тільки зі статусу «На погодженні» при дії «Відхілити» від COO. Відхилена заявка більше не обробляється в рамках процесу. За потреби замовник може внести правки і створити нову заявку (або функціоналом передбачити повторне подання тієї ж, що не рекомендується для прозорості історії). UI: Відхилена заявка має чітку позначку (наприклад, червоний статус) та можливість переглянути коментар/причину відхилення, якщо таку додали при відхиленні.

**Примітка:** У першій версії не передбачається окремого статусу завершення («Завершено») для заявки. Вважається, що заявка залишається «В роботі» доки триває закупівля, і фактично процес заявки завершується поставкою всіх ТМЦ (що відображається на рівні рахунку/позицій). Однак у майбутньому можна додати статус «Завершена» або «Закрита», коли всі пов'язані рахунки оплачені та товари отримано.

### Статуси позицій заявки

Кожна позиція (рядок табличної частини) має власний статус, що дозволяє відстежувати прогрес для кожного товару/послуги окремо. Це особливо важливо при часткових поставках або якщо різні позиції закуповуються у різних постачальників (можливе розширення в майбутньому). На етапі впровадження статуси позицій будуть оновлюватися вручну відповідальними особами (менеджером постачання або казначеєм). Передбачені такі статуси позиції:

- **В роботі** – позиція знаходиться в процесі закупівлі. Цей статус присвоюється позиціям автоматично, коли заявка перейшла в статус заявки «В роботі» (після погодження). Означає, що менеджер постачання працює над придбанням цього товару/послуги.

- **На погодженні** – якщо виникає необхідність погоджувати окрему позицію (наприклад, заміну товару або зміну кількості), її можна перевести на погодження. На першій ітерації процесу, скоріш за все, статус «На погодженні» для позиції буде синхронізовано із загальним статусом заявки. Тобто всі позиції заявки перебувають на погодженні, коли заявка «На погодженні».

- **Оплата** – позиція очікує оплати. Цей статус на рівні позиції зазвичай відображає, що для даної позиції вже сформовано рахунок і він очікує оплати (або рахунок на етапі «Оплата»). У практичному вимірі, після того як рахунок виставлено і погоджено, всі позиції, що в нього входять, можуть отримати статус «Оплата».

- **Оплачено** – позиція оплачена. Після того, як бухгалтер-казначей відмітив рахунок як «Оплачено», всі позиції в цьому рахунку переводяться в статус «Оплачено». Це означає, що фінансово зобов'язання виконані, і очікується постачання по цій позиції.

- **Доставлено** – позиція доставлена/отримана. Коли товар по цій позиції фактично отримано на склад (або послугу надано) і менеджер постачання (або відповідальний складський працівник) відмічає отримання, статус позиції змінюється на «Доставлено». Якщо поставка здійснюється частково, можливе часткове оновлення (наприклад, через поле «кількість доставлено/залишилось» – можливість до розширення).

- **Відхилено** – позиція скасована або відхилена. Може виникнути, якщо конкретний товар більше не потрібен або його закупівлю скасовано окремо від решти заявки. В початковій реалізації відхилення окремої позиції можливе шляхом редагування заявки в чернетці або відхилення всієї заявки. Окремий статус «Відхилено» для позиції може стати в нагоді при частковому виконанні (наприклад, одна позиція з трьох відхилена керівництвом, а дві – дозволені). Поки що, якщо заявка відхилена, вважаємо, що всі позиції теж відхилені.

**Примітка:** Статуси позицій тісно пов'язані зі статусами Рахунку. Насправді після створення рахунку і його переходу через етапи «Оплата», «Оплачено», «Доставлено» – ці ж стани відображаються і на рівні позицій. Тож логіку оновлення статусів позицій можна реалізувати автоматично при зміні статусу рахунку (наприклад, рахунок став «Оплачено» – всі пов'язані позиції теж «Оплачено»). Поки що, в першій версії, можна передбачити ручну зміну статусів позицій менеджером (для «Доставлено») і казначеєм (для «Оплачено»), або автозміну при зміні рахунку.

## Структура даних: Рахунок на закупівлю

Рахунок у даному контексті – це документ, який створюється на основі заявки після її погодження і містить деталі для здійснення закупівлі у постачальника. Рахунок успадковує інформацію із заявки (найменування та кількість позицій тощо), але додає фінансові та постачальницькі реквізити. Рахунок проходить власний цикл погодження та виконання.

### Поля рахунку

Нижче наведено основні поля для об'єкта «Рахунок»:

| Поле | Тип даних | Опис |
|------|-----------|------|
| Номер рахунку | String (можливо автогенерований) | Унікальний ідентифікатор рахунку в системі. Може генеруватися автоматично (окремя нумерація для рахунків) або заповнюватися менеджером (наприклад, номер рахунку постачальника). |
| Пов'язана заявка | Reference (ID заявки) | Зв'язок з заявкою, на основі якої створено рахунок. Це дозволяє відстежувати, до якої заявки належить даний рахунок. |
| Дата створення рахунку | DateTime (readonly) | Дата і час, коли рахунок був створений в системі. Проставляється автоматично при створенні рахунку менеджером постачання. |
| Постачальник | Довідник контрагентів / String | Назва або ідентифікатор постачальника, у якого здійснюється закупівля. Менеджер постачання обирає постачальника з довідника або вводить вручну, створюючи прив'язку. |
| Умови оплати | Перелік (option) | Умови оплати за договором/рахунком: передплата (аванс) чи відтермінування (постоплата). Опція, яку вказує менеджер. За потреби, можна уточнювати відтермінування у днях. |
| Очікувана дата поставки | Date | Дата, коли очікується поставка товарів згідно з умовами рахунку. Може співпадати або уточнювати «бажану дату» з заявки з врахуванням домовленостей з постачальником. |
| Сума рахунку | Decimal/Currency | Загальна сума до оплати за цим рахунком. Розраховується на основі вартості позицій або вводиться вручну менеджером. Може включати валюту. |
| Статус рахунку | Перелік (enum) | Поточний статус рахунку (див. опис статусів нижче). Редагується лише системно або уповноваженими ролями відповідно до процесу. |
| Перелік позицій | Масив об'єктів (таблиця) | Таблична частина, що зазвичай дублює позиції з заявки (із зазначенням погоджених кількостей). Додатково може містити ціну за одиницю та суму по позиції, якщо такі деталі потрібні. |
| Інші поля | ... | За потреби, рахунок може містити допоміжні поля: примітки, посилання на файли (скан рахунку), поле «Оплачено (дата/номер платежу)», позначку про оприбуткування тощо. Ці поля можна додавати в рамках розширення функціоналу. |

**Примітки щодо полів рахунку:**
- Рахунок успадковує список позицій із заявки: при створенні рахунку всі позиції заявки копіюються в рахунок. При цьому, до позицій можуть додаватися фінансові дані (наприклад, ціна за одиницю, сума). У першій версії систему можна спростити – не вести детальний облік цін по кожній позиції, а лише сумарну суму рахунку.
- Поле «Номер рахунку» може служити для збереження номера рахунку постачальника (якщо є паперовий/електронний документ від постачальника). Для внутрішнього використання можна також генерувати внутрішній номер.
- Постачальник – бажано обирати з наявного довідника постачальників, щоб забезпечити консистентність даних (уникнення дубльованих назв). Якщо такого модулю немає, достатньо текстового поля з назвою компанії.
- Очікувана дата поставки – дозволяє менеджеру скоригувати початкову бажану дату з заявки відповідно до реальних домовленостей з постачальником.
- Сума рахунку – для контролю бюджету бажано відображати і суму. У майбутньому (для аналітики) це ключове поле. На першому етапі менеджер може вручну вводити суму, або ж вона рахується автоматично (якщо будуть додані ціни у позиціях).
- Додаткові поля (опціонально): можна передбачити прикріплення файлів (наприклад, PDF копії рахунку від постачальника), поле для коментарів фінансового відділу тощо. Ці поля не є обов'язковими для початкового функціоналу, але структура даних повинна дозволити їх додавання без переробки існуючих (наприклад, таблиця файлів-прив'язок за ID рахунку).

### Статуси рахунку

Рахунок проходить власний життєвий цикл, узгоджений з процесом платежу і постачання. Статуси рахунку та їх призначення такі:

- **Чернетка** – рахунок створено менеджером постачання, але ще не передано на погодження. У цьому статусі менеджер може редагувати деталі рахунку (додати/редагувати постачальника, суми, умови оплати). Рахунок-чернетка видимий лише менеджеру постачання та, можливо, відповідним керівникам відділу постачання, але не керівництву чи бухгалтерії. Перехід з «Чернетка» в «На погодженні» відбувається, коли менеджер натискає «Відправити на погодження» рахунок.

- **На погодженні** – рахунок очікує затвердження. У цьому статусі рахунок доступний для перегляду і дії COO та CEO. COO та CEO розглядають рахунок незалежно один від одного та можуть погодити або відхилити його. Для переходу рахунку в наступний статус («Оплата») потрібні дві позитивні відповіді (погодження і COO, і CEO). Під час погодження рахунок доступний для читання бухгалтерії (щоб вони могли підготуватися до оплати, наприклад), але без можливості редагування. Якщо хоча б один із них відхиляє рахунок, статус змінюється на «Відхилено», і рахунок не підлягає виконанню (можливо, менеджер повинен буде скоригувати дані або створити новий рахунок).

- **Оплата** – рахунок затверджено і передано до оплати. Цей статус означає, що фінансовий відділ може здійснювати платіж. Рахунок у статусі «Оплата» стає видимим та активним для бухгалтера-казначея. В цьому статусі менеджер постачання та керівники вже не змінюють рахунок – очікується дія від казначея. Казначей здійснює оплату поза системою (наприклад, через банк-клієнт) і після фактичної оплати вручну відзначає оплату в системі (заповнює дату оплати, номер платіжного документу).

- **Оплачено** – рахунок сплачено повністю. Цей статус встановлює бухгалтер-казначей після того, як кошти перераховані постачальнику. При переході рахунку в «Оплачено» автоматично (або вручну) змінюються статуси всіх позицій на «Оплачено». Також в рахунку може фіксуватися інформація про оплату (дата, хто відмітив). Після цього етапу відповідальність переходить з фінансистів назад до менеджера постачання (або відповідальної особи за отримання).

- **Доставлено** – товар (ТМЦ) за цим рахунком поставлено і отримано на склад. Менеджер постачання (або складський працівник) відмічає в системі факт отримання товарів. Це може бути реалізовано як зміна статусу рахунку на «Доставлено» (або «Поставка завершена»). При цьому всі позиції рахунку отримують статус «Доставлено». Бухгалтерія отримує підтвердження, що товари прибули, і може почати процес оприбуткування в 1С.

- **Відхилено** – рахунок не затверджено керівництвом і відхилено на етапі погодження. У цьому статусі рахунок закривається для виконання: його не можна оплатити або доставити. Менеджер постачання може переглянути причину відхилення (якщо додано коментар) і на основі цього внести зміни (наприклад, змінити постачальника, ціну) та сформувати новий рахунок або відправити на повторне погодження (можливі варіанти реалізації: дозволити редагувати відхилений рахунок і знову відправити або вимагати створити новий рахунок – вирішується правилами компанії).

**Примітка:** Аналогічно заявці, статус «Чернетка» та «На погодженні» рахунку є проміжними і не відображують виконання, а лише процес узгодження. Статуси «Оплата», «Оплачено», «Доставлено» – відображають виконання. Після «Доставлено» процес рахунку (а фактично і відповідної заявки) можна вважати завершеним. У майбутньому може додаватися статус «Закрито» або «Архівований» для документів, які повністю завершені і перевірені (наприклад, після оприбуткування в 1С і перевірки бухгалтером).

### Відношення між заявкою та рахунком

- Кожна заявка «Закупівля ТМЦ» в загальному випадку призводить до створення одного рахунку (якщо всі позиції замовляються у одного постачальника в рамках одного замовлення). Система повинна забезпечити створення рахунку на основі заявки з копіюванням усіх позицій та основних даних.
- Існує можливість (у майбутньому) реалізувати кілька рахунків на одну заявку – наприклад, якщо різні позиції замовлення закуповуються у різних постачальників. У першій версії така ситуація не реалізується (менеджер вибирає одного постачальника на всю заявку), але структура даних повинна це врахувати. Зокрема, можна передбачити окрему сутність для зв'язку заявок і рахунків (щоб не обмежувати співвідношення 1:1 жорстко). Наприклад, таблиця PurchaseInvoice з полем request_id (Foreign Key на заявку) дозволить зберігати кілька рахунків з посиланням на одну заявку.
- При видаленні або скасуванні заявки слід врахувати наявність рахунків. Якщо заявка відхилена або скасована, пов'язаний рахунок (якщо вже був створений) також слід помітити як недійсний/скасований або сповістити користувача. Навпаки, якщо рахунок відхилено, можна повернути заявку в статус «В роботі» для можливості повторного випуску рахунку.

## Логіка переходів та дій користувачів

Цей розділ описує послідовність дій в процесі та те, як змінюються статуси заявки і рахунку у відповідь на дії користувачів. Логіка повинна бути реалізована як у Frontend (UI) для відображення кнопок/дій, так і у Backend для перевірки прав і виконання переходів. Важливо, щоб всі переходи були транзакційними (успішна дія змінює статус і пов'язані дані, невдала – не змінює нічого).

### 1. Створення заявки (Чернетка → На погодженні)

**Хто:** Заявник (будь-який користувач).

**Дія в UI:** Натискає кнопку «Створити заявку», заповнює поля заявки і додає позиції, потім зберігає. Спочатку заявка зберігається як «Чернетка».

**Додаткова можливість:** Заявник може вийти і повернутися до редагування чернетки пізніше.

**Відправка на погодження:** Коли заявка готова, заявник натискає «Відправити на погодження». Система перевіряє наявність обов'язкових полів та позицій. Статус заявки змінюється на «На погодженні». Встановлюється мітка часу і фіксується, хто відправив (замовник). Відповідні користувачі (COO) отримують сповіщення про нову заявку на погодження (наприклад, у UI список задач, або email/Telegram-сповіщення – останнє може бути додано пізніше).

### 2. Погодження заявки (На погодженні → В роботі або Відхилена)

**Хто:** COO.

**Дія COO:** в своєму інтерфейсі (наприклад, розділ «Заявки на погодження») COO відкриває заявку, ознайомлюється з деталями і позиціями. Доступні кнопки «Погодити» або «Відхилити».

- При погодженні заявка змінює статус на «В роботі», фіксується хто і коли погодив; заявник може отримати повідомлення про погодження.
- При відхиленні статус стає «Відхилена» одразу, фіксується хто і коли відхилив; заявник може отримати повідомлення про відхилення. COO може додати коментар (причину відхилення), який збереже система.

### 3. Опрацювання заявки менеджером (створення рахунку)

**Хто:** Менеджер постачання.

**Дія:** Менеджер бачить список погоджених заявок (статус «В роботі»). Обирає конкретну заявку, вивчає її позиції. Менеджеру доступні дії: «Створити рахунок», можливо також «Додати коментар», «Змінити відповідального» тощо.

**Створення рахунку:** При ініціюванні дії «Створити рахунок»:
- Відкривається форма нового рахунку, в якій автоматично заповнюються поля, що успадковуються з заявки: замовник, список позицій (найменування та кількість), ID заявки тощо.
- Менеджер заповнює поля рахунку, яких не було в заявці: вибирає постачальника, вказує умови оплати, очікувану дату поставки, ціну/суму якщо потрібно.
- Після заповнення менеджер зберігає рахунок. Спочатку рахунок має статус «Чернетка» (можна зберегти проміжний стан, не відразу подавати на підпис).
- Менеджер може перевірити ще раз всі дані. Коли готовий – натискає «Відправити рахунок на погодження». Статус рахунку змінюється на «На погодженні». В хронології заявки також може з'явитися запис, що створено рахунок №X і відправлено на погодження.

**Автоматичні зміни:** При створенні рахунку зі статусом «На погодженні», заявка може лишатися у статусі «В роботі». Можливо, для відображення, що по заявці вже є рахунок, можна додатково помічати заявку як «В роботі (рахунок на погодженні)» – але це радше UI-деталь. В таблиці позицій кожна позиція може отримати статус «Оплата» або залишитися «В роботі» до моменту оплати (вирішується як відображати до факту оплати).

### 4. Погодження рахунку (На погодженні → Оплата або Відхилено)

**Хто:** COO та CEO (паралельно).

**Дія COO:** відкриває рахунок, перевіряє постачальника, суму, умови. Може бачити прив'язану заявку та переконатися, що все відповідає погодженому. COO натискає «Погодити» або «Відхилити».
- При погодженні у системі фіксується погодження COO, але статус рахунку залишається «На погодженні», доки не буде рішення CEO.
- При відхиленні статус одразу змінюється на «Відхилено» (і процес рахунку завершується, хронологія фіксує відмову COO, повідомляється менеджеру постачання).

**Дія CEO:** переглядає рахунок у власному інтерфейсі. CEO має такі ж опції «Погодити»/«Відхилити» (з можливістю додати коментар).
- Якщо CEO погоджує рахунок і COO вже погодив, рахунок отримує статус «Оплата».
- Якщо CEO відхиляє рахунок – статус змінюється на «Відхилено» (фіксується відмова CEO), навіть якщо COO вже погодив.

**Системно:** при переході рахунку в статус «Оплата» з'являється завдання для бухгалтера-казначея виконати оплату. Можна реалізувати список рахунків в статусі «Оплата» для казначея. Всі позиції рахунку отримують (або вже мали) статус «Оплата» (очікує оплати). Можна встановити мітку часу затвердження та розрахувати граничну дату оплати (якщо є платіжний дедлайн по умовах).

Якщо рахунок відхилено будь-яким із погоджувачів (COO або CEO), менеджер постачання отримує повідомлення і може відредагувати рахунок (якщо дозволено) та повторно відправити, або створити новий рахунок. В системі відхилений рахунок зберігається для історії (йому можна присвоїти статус «Відхилено», подальші зміни не допускаються, окрім коментарів). Заявка при цьому залишається у статусі «В роботі», і менеджер може спробувати знову (інша ціна, постачальник тощо).

### 5. Оплата рахунку (Оплата → Оплачено)

**Хто:** Бухгалтер-казначей.

**Дія:** Казначей бачить усі рахунки в статусі «Оплата» (затверджені до оплати). Виконавши платіж поза системою (через банк), він повертається в Lovable і відкриває картку рахунку. Казначею доступна дія «Позначити як оплачений» (або окреме поле «Дата оплати», яке треба заповнити і зберегти).

**Заповнення деталей оплати:** При позначенні оплачено, система може запропонувати ввести:
- Дату оплати (за замовчуванням поточна дата, можна змінити на фактичну).
- Номер платіжного документа або підтвердження (опціонально, для довідки).
- Можливо, прикріпити файл платіжного доручення (опційно).

**Підтвердження оплати:** Після підтвердження дії рахунок отримує статус «Оплачено». Система фіксує користувача (казначея) і дату. Всі позиції рахунку автоматично змінюють статус на «Оплачено».

**Повідомлення:** Менеджер постачання отримує сповіщення (наприклад, в системі) що рахунок оплачено і можна очікувати постачання. В хронології рахунку з'являється запис про оплату.

**Без інтеграції:** Оскільки інтеграції з банком немає, цей процес ручний. У майбутньому (при інтеграції з 1С чи банком) статус «Оплачено» може виставлятися автоматично на основі отриманих виписок чи даних з 1С.

### 6. Отримання товарів (Оплачено → Доставлено)

**Хто:** Менеджер постачання або відповідальна особа (склад).

**Дія:** Після оплати постачальник відвантажує товари. Коли товари/матеріали прибувають, відповідальний відкриває рахунок у системі. Доступна дія «Позначити як доставлено» або «Отримано товар».

**Позначення доставки:** Відповідальний переконується, що всі позиції отримані в потрібній кількості. Якщо так – виконує дію, і рахунок змінює статус на «Доставлено». Також можна окремо відзначати по кожній позиції (наприклад, у таблиці позицій вводити фактично отриману кількість, особливо якщо частково). В першій версії достатньо просто змінити статус рахунку на «Доставлено», припускаючи що отримано все. Система автоматично виставляє статус «Доставлено» для кожної позиції.

**Документообіг:** Після отримання товарів менеджер постачання має отримати закриті документи від постачальника (накладні, рахунок-фактуру тощо). Поки що система це не контролює, але передбачено в процесі, що потрібно проконтролювати отримання документів. У майбутньому можна додати позначку/поле «Отримані документи від постачальника» з датою.

**Завершення процесу:** Статус «Доставлено» фактично означає, що закупівля виконана. На цьому етапі бухгалтерія може приступити до оприбуткування товарів в обліковій системі (1С). В Lovable можна вважати процес закупівлі завершеним.

### 7. Оприбуткування в 1С (дія поза системою Lovable)

**Хто:** Бухгалтер.

**Опис:** Бухгалтер отримує від менеджера постачання пакет документів по поставці. Оприбуткування проводиться в системі 1С (зовнішній крок). В Lovable наразі це не автоматизовано.

**Фіксація в системі:** Опціонально, після підтвердження, бухгалтер може вручну відзначити в рахунку поле «Оприбутковано в 1С» (якщо таке буде додано) або прикріпити копії документів. Ці дані важливі для контролю, але їх реалізація належить до інтеграції з 1С і виходить за межі першої версії.

**Статус документа:** Після оприбуткування та отримання всіх документів, рахунок (і заявка) можуть бути переведені в кінцевий стан (наприклад, «Завершено» або залишаться «Доставлено»). Це логічне завершення бізнес-процесу.

### Діаграма процесу (Умовно)

Послідовність статусів та відповідальних виглядає так:

**Заявка:** Чернетка (Замовник) → На погодженні (COO) → В роботі (Менеджер) → [створено рахунок] →

**Рахунок:** На погодженні (COO & CEO, паралельно) → Оплата (Казначей) → Оплачено (Казначей) → Доставлено (Менеджер).

Це відповідає крокам, описаним вище, і показує, як різні ролі вступають на різних етапах процесу.

## Вимоги до інтерфейсу (UI)

Інтерфейс користувача має бути інтуїтивним для кожної ролі та відображати тільки релевантну інформацію і можливі дії. Оскільки система Lovable вже містить частково працюючий функціонал, нові елементи інтерфейсу потрібно додати послідовно, не змінюючи поведінку існуючих. Основні вимоги та зміни в UI:

### Навігація та меню

У головному меню додати розділ «Закупівля ТМЦ». При виборі цього розділу користувач бачить підрозділи/сторінки, пов'язані з процесом:
- Список заявок «Закупівля ТМЦ» (з фільтрацією за статусами, мої/всі тощо).
- Можливо, окремо список рахунків (наприклад, для бухгалтерії зручно мати список рахунків, що очікують оплати).
- Для ролей погоджувачів – може бути представлення типу "На погодженні" (список задач на затвердження).

Навігація може бути організована як окремий пункт в головному меню або як вкладки у розділі «Закупівля ТМЦ». Якщо в системі вже є головне меню для інших процесів, додати цей пункт туди, забезпечивши візуальну єдність.

### Списки та фільтри

**Список заявок:**
- Табличний вигляд з колонками: Номер заявки, Замовник, Дата створення, Тип закупівлі, Статус, можливо Сума (якщо відома), Бажана дата поставки.
- Фільтрація за статусами (чернетка, на погодженні, в роботі, відхилена).
- Можливість сортування за датою, статусом.
- Пошук за номером заявки або замовником.
- Для кожної ролі – відображення лише релевантних заявок (наприклад, COO бачить тільки «На погодженні», менеджер – «В роботі», замовник – тільки свої).

**Список рахунків:** Аналогічно до заявок, відображення полів: Номер рахунку, Постачальник, Сума, Статус, Пов'язана заявка. Фільтри за статусами, пошук тощо.

### Форми створення та редагування

**Створення заявки:**
- Форма з полями, описаними вище (Тип закупівлі, Бажана дата поставки тощо).
- Поля «Замовник» і «Дата створення» – заповнюються автоматично (readonly або приховані).
- Додавання позицій: внизу форми таблична секція, де можна додавати рядки позицій з полями Найменування, Одиниця, Кількість. Можливість додати/видалити позиції.
- Кнопки «Зберегти як чернетку», «Відправити на погодження».
- Валідація: перевірка наявності хоча б однієї позиції і заповнення обов'язкових полів перед відправкою на погодження.

**Редагування заявки (для чернеток):** Аналогічна форма. Якщо заявка вже на погодженні або далі – редагування відключене (або обмежено).

**Створення рахунку (форма менеджера постачання):**
- При натисканні «Створити рахунок» на основі заявки форма відкривається з автозаповненими полями з заявки (позиції, замовник).
- Додаткові поля для вводу: Постачальник (вибір з довідника або текстове поле), Умови оплати (dropdown), Очікувана дата поставки, Сума рахунку (можливо автообчислена, можливо ручне введення).
- Таблична частина з позиціями (скопійовано з заявки, можливість редагувати кількість чи ціни, якщо потрібно деталізувати).
- Кнопки: «Зберегти чернетку», «Відправити на погодження».

**Редагування рахунку:** Доступно менеджеру в статусі чернетки. Після відправки на погодження – тільки для читання.

### Відображення статусів

- **Бейдж/колір статусів:** Кожен статус повинен мати чіткий візуальний вигляд (колір, іконка). Наприклад:
  - Чернетка – сірий (неподаний документ).
  - На погодженні – блакитний/жовтий (очікування).
  - В роботі – синій (виконується).
  - Оплата – фіолетовий або оранжевий (фінансовий етап).
  - Оплачено – зелений (оплачено, очікується постачання).
  - Доставлено – зелений (завершено поставку).
  - Відхилено – червоний (зупинено).

- **Адаптивність:** Оскільки можливий доступ через різні пристрої, інтерфейс має коректно відображатися і на невеликих екранах. Списки можна зробити з прокруткою по горизонталі при великій кількості колонок або зі згортанням деяких полів.

- **Мови:** Інтерфейс – українською (відповідно до техзавдання). Усі назви полів, повідомлення про помилки, підказки – українською.

### Повідомлення та нотифікації

У першій версії мінімально передбачити внутрішні повідомлення:
- Наприклад, після дій («Заявку відправлено на погодження», «Рахунок погоджено» тощо) – показувати короткі повідомлення (toast або модальні).
- Для критичних моментів (відхилено) – повідомлення заявнику/менеджеру.
- У майбутньому можна додати e-mail або Telegram-нотифікації, це зазначено як напрям розширення.

**UI-приклад для довідки:** Картка заявки може мати вигляд вкладок або секцій: "Деталі заявки" (поля), "Позиції" (таблиця), "Хронологія" (список подій), "Пов'язані документи" (рахунки, файли). Аналогічно для рахунку. Така структура зрозуміла розробникам Lovable і дозволить не переплутати інформацію.

## Вимоги до Backend та API

Серверна частина (backend) повинна підтримати новий бізнес-процес, забезпечуючи збереження даних, бізнес-логіку переходів і перевірку прав доступу. Основні вимоги:

### Моделі даних

Створити нові моделі (таблиці) для Заявки та Рахунку відповідно до описаної структури. Зважати на:
- Індексацію полів, що часто використовуються у фільтрах (наприклад, статус, замовник).
- Зв'язки: заявка -> рахунок (1-to-many або 1-to-1, з потенціалом 1-to-many), заявка -> позиції (1-to-many), рахунок -> позиції (можливо 1-to-many або використати ті ж позиції з посиланням на рахунок).
- Таблиці довідників для статичних списків (тип закупівлі, одиниці виміру, можливо постачальники).

### Міграції БД

Додати міграції для створення необхідних таблиць і зв'язків. Переконатися, що вони не зачіпають існуючі таблиці або, якщо зачіпають (наприклад, додають нові поля в універсальні таблиці користувачів чи довідників), то роблять це in a backward-compatible way (заповнення за замовчуванням, non-null тощо).

### API ендпоїнти

**Для заявок:**
- створення заявки (POST /api/purchase-requests)
- отримання списку (GET /api/purchase-requests?filter=...)
- отримання однієї (GET /api/purchase-requests/{id})
- оновлення (для статусів або відхилення, зазвичай через спеціальні дії)
- видалення (можливо не видаляємо фізично, а позначаємо)

**Для рахунків:**
- створення рахунку (POST /api/purchase-invoices, в т.ч. з прив'язкою до заявки)
- отримання списку рахунків
- отримання рахунку
- дії типу «позначити оплаченим» або «позначити доставленим» – можна зробити як окремі ендпоїнти або як оновлення ресурсу рахунку з певним статусом

**Для довідників/допоміжних:**
- ендпоїнти для списку постачальників (якщо не вже існує), для одиниць виміру тощо

### Захист API

Переконатися, що контроль доступу реалізовано на рівні бекенду. Наприклад, звичайний користувач може POST /purchase-requests (створити) тільки від свого імені, не може скористатись API для схвалення заявки тощо. Використати роль/permissions з токена користувача.

### Валідація

Бекенд повинен перевіряти обов'язкові поля при створенні/оновленні. Не довіряти тільки фронтенду. Наприклад, не дозволити відправити заявку на погодження, якщо немає жодної позиції, або кількість = 0, тощо.

### Бізнес-логіка на бекенді

Критичні переходи статусів мають бути реалізовані на бекенді (напряму або через сервісний шар):
- **Endpoint для погодження заявки:** перевіряє, що користувач – COO і що заявка зараз у статусі «На погодженні» і ще не була ним оброблена. Далі змінює статус (на «В роботі» при погодженні або «Відхилена» при відхиленні) та фіксує дату/час і користувача.
- **Endpoint для відхилення заявки:** аналогічно, зберігає статус «Відхилено» та коментар.
- **Аналогічно для рахунків:** endpoints для погодження/відхилення рахунку.
- **Endpoint «оплата підтверджена»:** перевіряє роль (казначей), статус рахунку (має бути «Оплата»), приймає дані про оплату, оновлює статус.
- **Endpoint «поставка підтверджена»:** роль (менеджер постачання), статус рахунку («Оплачено»), змінює статус на «Доставлено», фіксує дату.

### Transaction management

Коли міняється статус рахунку, потрібно оновити й статуси позицій, і, можливо, пов'язаної заявки. Ці операції повинні виконуватися атомарно. Використовувати транзакції БД або відповідні механізми ORM, щоб не було розбіжностей (наприклад, щоб не сталося, що рахунок «Оплачено», а позиції лишились «Оплата» через збій).

### Не порушити існуючий код

- Переконатися, що назви нових endpoint-ів, моделей, маршрутів не конфліктують з існуючими. Namespace API під процес purchase або tmc (щоб відрізнити від інших модулів).
- Перевірити, чи використовується у системі спільна черга номерів для документів – якщо так, забезпечити конфігурацію, щоб номери не перетинались.
- UI виклики нових API не повинні впливати на старі (наприклад, глобальні обробники помилок/авторизації вже покриють нові, але специфічні речі – треба додати).

### Журнали та аудит

Усі критичні дії записувати у лог (бажано і в базу для хронології – можливо, окрема таблиця AuditLog чи History з полями: тип документу, ID, дія, користувач, дата, коментар). Ця таблиця дасть бекенду можливість віддавати на фронт історію для відображення. Формат записів можна узгодити (наприклад, human-readable текст або структуровано). Можна також вести системний лог (файл) для відстеження проблем.

### Тестування і валідація

Оскільки процес новий, потрібне ретельне тестування на стейджингу. Бекенд має включати unit-тести або хоча б postman-колекцію для основних сценаріїв:
- Створення заявки, погодження, відхилення.
- Створення рахунку, погодження, відхилення.
- Оплата, доставка.
- Спроби некоректних дій (неправильні ролі або статуси).

### Продуктивність

Обсяг даних спочатку невеликий, але проектуючи, врахувати оптимізацію – наприклад, вибірки списків заявок/рахунків робити з фільтрами по статусу та ролі (SQL-джоін з таблицею прав або в ORM фільтрувати). Використати пагінацію на списках.

## Можливості подальшого розширення

Проектування повинно одразу врахувати потенційні доробки, аби їх впровадження не вимагало кардинальної зміни вже написаного коду. Нижче окреслені напрямки розширення і як їх передбачити в архітектурі:

### Матриця погодження (Approval Matrix)

У майбутньому можливе налаштування складніших правил погодження (наприклад, залежно від суми закупівлі, типу ТМЦ – різні особи погоджують, або потрібне погодження юриста/бухгалтера). Щоб це врахувати:
- Зробити систему погоджень більш гнучкою. Замість жорстко зашитого списку «COO → CEO», можна мати таблицю/налаштування правил: хто погоджує, послідовність, за яких умов. В першій версії це може бути захардкожено для COO і CEO, але структура БД може мати таблицю ApprovalStage (document_type, role, order, optional_condition...).
- Логіка отримання «від кого очікується погодження» теж може базуватися на цій матриці, щоб не переписувати UI при зміні процесу.

### Аналітика і звітність

Після накопичення даних про закупівлі з'явиться потреба в аналітиці (кількість заявок, середній час погодження, витрати по категоріях тощо). Щоб полегшити це:
- Структуру даних проектувати нормалізовано: поля суми, дати, типів мають зберігатися і бути доступні для SQL-запитів.
- Зберігати історичні дані (не перетирати записи погоджень, а кожен етап як запис в історії). Таким чином можна вирахувати тривалість етапів.
- Можливо, передбачити прості статуси для звітів: наприклад, маркер, що заявка успішно завершена, або рахунок скільки днів у статусі «На погодженні» був.

### Telegram-нотифікації та e-mail

Передбачити інтеграцію з зовнішніми сервісами повідомлень. На рівні архітектури можна закласти:
- Модуль/сервіс Notification, який отримує події (Event Bus або просто виклики) при певних діях (створено заявку, потребує погодження, відхилено, і т.д.).
- Наразі він може бути заглушкою (logging), але в майбутньому підключити туди відправку повідомлень.
- Це дозволить легко додати різні канали (email, Telegram) без модифікації бізнес-логіки – лише реалізувавши обробник подій.

### Контроль документів

За процесом, після доставки товарів повинні надійти закриваючі документи від постачальника (накладна, рахунок-фактура). Для цього у майбутньому можна:
- Додати поля в рахунку: «Документи отримано» (так/ні, дата), «Дата оприбуткування в 1С», «Номер прибуткового ордера» тощо.
- Додати можливість завантажити скани цих документів в систему (зв'язок рахунок-файл).
- На рівні процесу: ввести ще один статус, наприклад, «Очікує документи» між «Доставлено» та фінальним завершенням. Але це необов'язково, можна просто не закривати рахунок, поки бухгалтер не відзначить отримання документів.
- Архітектурно: мати гнучку модель для прикріплення файлів (можливо, вже реалізовано в Lovable), та не видаляти рахунок до отримання документів.

### Часткові поставки

Якщо постачальник відвантажує товари по частинах, система повинна це підтримати:
- Зробити можливим оновлення статусу окремих позицій на «Доставлено» незалежно. Наприклад, у рахунку дозволити вводити фактично отриману кількість по позиції і якщо вона менша за замовлену – вважати, що постачання триває (статус рахунку може залишатися «Оплачено» або «Частково доставлено»).
- Можна додати статус рахунку «Частково доставлено» автоматично, якщо частина позицій відмічена як доставлена, а частина – ні.
- Такі складнощі краще закладати наперед: наприклад, структура таблиці позицій може мати поле quantity_delivered. В першій версії воно може не використовуватися активно, але в майбутньому дозволить реалізувати облік часткової поставки без зміни схеми БД.

### Інтеграція з 1С та банком

**1С (бухгалтерія/склад):** Після того як процес стабільно працюватиме вручну, планується інтеграція для автоматичного обміну даними. Для цього:
- В таблицях рахунків/заявок варто мати поля для зберігання ID відповідних документів 1С (щоб уникнути дублювань). Наприклад, accounting_id або erp_id.
- API для інтеграції: наприклад, ендпоїнт, який може викликатися 1С для отримання списку рахунків «Оплачено, не оприбутковано» або для встановлення прапорця «оприбутковано».
- Можливо, webhooks або обмін через файли. Це наразі не реалізується, але код слід писати з врахуванням, що може з'явитися окремий модуль інтеграції. Головне – не закладати логіку, несумісну з цим (наприклад, не розраховувати, що тільки вручну вводитиметься "оплачено" назавжди).

**Інтеграція з банком:** Щоб позбутися ручної відмітки оплати, можна інтегрувати банківські виписки або API банку.
- Можна мати поле payment_reference (номер транзакції) та payment_date – що ми вже заклали. Якщо налаштувати імпорт виписок, система може знаходити рахунки за сумою і №, та автоматично виставляти «Оплачено».
- Закладатися на це можна, чітко розділивши статус «Оплата» (очікує дії) і «Оплачено» (виконано). Якщо в майбутньому оплата приходить автоматично, казначей може не заходити взагалі – але процес для решти ролей не зміниться.

### Розширення UI/UX

З часом може виникнути потреба в додаткових фільтрах, сортуванні: наприклад, бухгалтеру потрібно відфільтрувати всі рахунки, які вже доставлені але документи не надійшли. Структура даних, відповідно, має дозволяти такі запити (поля для документів, статусів).

**Мобільна версія / сповіщення:** можливо, реалізація спрощеного інтерфейсу погодження через мобільний додаток чи Telegram-бот. Якщо система побудована модульно (виокремлений сервіс нотифікацій, API, який може викликатися зовнішнім ботом), це спростить розробку.

### Безпека та аудит

При розширенні функцій завжди враховувати, щоб розширення не дало доступу зайвим користувачам. Тобто матриця прав має легко доповнюватись (нові ролі чи нові точки входу), а журнал дій – охоплювати нові події. Вже з першої версії варто вести audit log, щоб у випадку проблем проаналізувати послідовність дій.

**Всі ці розширення не потрібно реалізовувати негайно, але архітектурно (на рівні схеми БД, сервісів, компонентів) варто їх врахувати.** Це узгоджується з вимогою "поступового розширення функціоналу" – додаючи нові можливості, ми максимально перевикористовуємо існуючий код і додаємо новий поруч, не змінюючи вже відлагоджені частини.

## Таблиці полів і зв'язків (зведення)

Нижче подано зведену інформацію про основні сутності процесу, їх поля та зв'язки між ними:

### Сутність: Заявка (PurchaseRequest)

**Основні поля:**
- `id` (PK) – Унікальний ідентифікатор заявки.
- `number` – Номер заявки (string).
- `created_by` – ID користувача-замовника.
- `created_at` – Дата/час створення.
- `purchase_type` – Тип закупівлі (enum: TMC або Service).
- `desired_date` – Бажана дата поставки (date).
- `status` – Статус заявки (enum: Draft/Approval/InProgress/Rejected).

(Поля статусів можна зберігати як константи або довідник статусів.)

**Зв'язки:**
- Позиції: неявно зв'язані через окрему таблицю PurchaseRequestItem (з полем request_id).
- Рахунки: опціональний зв'язок, може бути поле invoice_id якщо 1:1, або окрема таблиця для зв'язку якщо 1:many.

### Сутність: Позиція заявки (PurchaseRequestItem)

**Основні поля:**
- `id` (PK).
- `request_id` (FK → PurchaseRequest) – до якої заявки належить.
- `name` – Найменування товару/послуги.
- `unit` – Одиниця виміру (string або FK → Unit dictionary).
- `quantity` – Кількість (decimal).
- `status` – Статус позиції (enum: InProgress/Approval/Payment/Paid/Delivered/Rejected).
- Можливі поля для розширення: `delivered_qty` (частково доставлено), `price` (ціна за одиницю, якщо відомо при створенні рахунку).

### Сутність: Рахунок (PurchaseInvoice)

**Основні поля:**
- `id` (PK).
- `request_id` (FK → PurchaseRequest) – посилання на заявку.
- `number` – Номер рахунку (string).
- `supplier_id` – Постачальник (FK → Supplier) або просто `supplier_name` (string, якщо без довідника).
- `created_at` – Дата створення рахунку.
- `created_by` – Хто створив (FK → User, має бути менеджер постачання).
- `payment_terms` – Умови оплати (enum: Prepay/Postpay, можливо int days for postpay).
- `expected_date` – Очікувана дата поставки (date).
- `amount` – Сума рахунку (decimal + currency).
- `status` – Статус рахунку (enum: Draft/Approval/Payment/Paid/Delivered/Rejected).
- Додаткові поля для розширення: `paid_date`, `payment_doc_no` (для фіксації оплати), `documents_received` (bool/date для отримання документів), `accounting_posted` (bool/date для оприбуткування).

### Сутність: Позиція рахунку (PurchaseInvoiceItem)

Може збігатися з PurchaseRequestItem, якщо вирішимо не дублювати, але найчастіше дублюємо, щоб зафіксувати ціну.

**Основні поля:**
- `id` (PK).
- `invoice_id` (FK → PurchaseInvoice).
- `name`, `unit`, `quantity` – копіюються з заявки.
- `price` – Ціна за одиницю (decimal, якщо потрібна деталізація).
- `amount` – Сума по цій позиції (price * quantity, або окремо, якщо є знижки).
- `status` – Статус позиції (можна дублювати статус із заявки, або вести окремо для випадку часткової поставки; в простій реалізації – ті ж статуси, що і в PurchaseRequestItem, і оновлюються синхронно).

### Сутність: Постачальник (Supplier)

Якщо не існує, варто додати для цілісності даних.

**Основні поля:** 
- `id`, `name`, `inn` (код), контакти тощо.

### Сутність: Журнал подій (PurchaseLog / Universal Log)

- `id`, `entity_type` (Request/Invoice), `entity_id`, `action` (string or enum: created, submitted, approved, ...), `timestamp`, `user_id`, `comment`.
- Логи зв'язані з заявкою чи рахунком через `entity_id`. Витягуючи їх, можна будувати хронологію.

### Зв'язки та каскадна логіка

Всі зв'язки повинні мати каскадну логіку видалення/оновлення відповідно до бізнес-вимог:
- Видалення заявки (якщо воно допускається для чернеток) має видаляти її позиції, а також пов'язані неузгоджені рахунки. Якщо заявка вже на погодженні чи далі – видалення не допускається, лише відміна.
- Видалення рахунку (чернетки) – можна дозволити менеджеру постачання, якщо, наприклад, він створив помилково, і немає погоджень.
- Оновлення довідників (наприклад, назва постачальника) – відобразиться на існуючих записах (якщо зберігаємо як FK, то при зміні назви в довіднику при відображенні нова назва підтягнеться).

## Висновок

Дане технічне завдання описує впровадження бізнес-процесу «Закупівля ТМЦ» у системі Lovable з урахуванням усіх необхідних ролей, статусів та даних. Документ структуровано таким чином, щоб розробники та CTO мали чітке уявлення про цілі та обсяг робіт, розуміли, як новий функціонал не порушить існуючий код і як забезпечити масштабованість рішення.

Впроваджуючи зазначені зміни, команда розробки повинна дотримуватися принципів: ізоляція нового модуля, повторне використання компонентів (де можливо), прозорість бізнес-логіки (відображення всіх дій у хронології) та готовність до наступних ітерацій розвитку продукту. Цей модуль значно підвищить рівень автоматизації внутрішніх процесів компанії Foodtech і закладе основу для подальшого розширення функціоналу системи.
